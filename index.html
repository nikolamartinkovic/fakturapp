<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FakturApp — Multi-user Invoice App (€)</title>
<style>
:root{--bg:#f4f7fb;--card:#fff;--accent:#0f62fe;--muted:#6b7280}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:#111}
.container{max-width:1100px;margin:28px auto;padding:20px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
.brand{display:flex;align-items:center;gap:12px}
.logoBox{width:64px;height:64px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#5aa0ff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
h1{font-size:20px;margin:0}
.card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(15,98,254,0.06)}
.grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
.input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px}
.btn{display:inline-block;padding:10px 12px;background:var(--accent);color:#fff;border-radius:8px;border:none;cursor:pointer}
.btn.secondary{background:#eef4ff;color:var(--accent);border:1px solid #d7e6ff}
.table{width:100%;border-collapse:collapse;margin-top:10px}
.table th,.table td{padding:10px;border-bottom:1px solid #eef2ff;text-align:left;font-size:14px}
.small{font-size:13px;color:var(--muted)}
.actions{display:flex;gap:8px;align-items:center}
.userBadge{background:#eef6ff;color:var(--accent);padding:6px 10px;border-radius:8px;font-weight:600}
.footer{margin-top:14px;text-align:center;color:var(--muted);font-size:13px}
.modal-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999}
.modal-box{background:#fff;padding:18px;border-radius:10px;max-width:420px;width:100%}
.row{display:flex;gap:8px}
@media (max-width:900px){.grid{grid-template-columns:1fr}.brand h1{font-size:16px}}
</style>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div id="appLogo" class="logoBox">FA</div>
      <div>
        <h1>FakturApp — Multi-user Invoice App (€)</h1>
        <div class="small">Register / Login, create invoices and export PDFs with your logo</div>
      </div>
    </div>
    <div class="actions">
      <div id="authArea"></div>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: Editor -->
    <div class="card">
      <h3 style="margin-top:0">Create Invoice</h3>

      <div style="display:flex;gap:8px;margin-bottom:10px">
        <input class="input" id="invDate" type="date" style="flex:1"/>
        <input class="input" id="invNumber" placeholder="Invoice number" style="width:180px"/>
      </div>

      <table class="table" id="itemsTable">
        <thead>
          <tr><th>Description</th><th>Qty</th><th>Unit (€)</th><th>Total (€)</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" id="addItem">Add item</button>
        <button class="btn secondary" id="calcTotals">Refresh totals</button>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
        <div>
          <button class="btn" id="saveInv">Save invoice</button>
          <button class="btn secondary" id="loadSample">Load sample</button>
        </div>
        <div style="text-align:right">
          <div class="small">Grand total:</div>
          <div id="grandTotal" style="font-weight:700;font-size:18px">0.00 €</div>
          <div id="creatorNotice" class="small"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Settings + list -->
    <div>
      <div class="card">
        <h3 style="margin-top:0">Saved Invoices</h3>
        <div id="invoicesList" class="invoices-list"></div>
        <div class="footer">Click "View" to load, "PDF" to export, or "Delete" to remove.</div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin-top:0">Settings & Logo</h4>
        <div class="small" style="margin-bottom:8px">Upload a PNG/JPG logo — it will appear in the header and in exported PDFs.</div>
        <input type="file" id="logoInput" accept="image/png,image/jpeg" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="applyLogo">Upload logo</button>
          <button class="btn secondary" id="removeLogo">Remove logo</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Auth modal container (will be shown programmatically) -->
<div id="authModalContainer" style="display:none"></div>

<script>
// -------------------------- App State --------------------------
const STORAGE_KEY = 'fakturapp_multi_v1';
let data = JSON.parse(localStorage.getItem(STORAGE_KEY) || JSON.stringify({
  users: [], // {username, passHash}
  invoices: [], // {id, invNumber, invDate, items, creator, logoDataUrl?}
  logoDataUrl: null, // global logo
  currentUser: null // username
}));

function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

// -------------------------- Utils --------------------------
function fmt(n){ return Number(n||0).toFixed(2) + ' €'; }
function uid(){ return 'inv_'+Date.now()+'_'+Math.random().toString(36).slice(2,8); }

// Async SHA-256 hash (if available), fallback to btoa
async function hashPassword(pw){
  if(window.crypto && crypto.subtle){
    const enc = new TextEncoder().encode(pw);
    const digest = await crypto.subtle.digest('SHA-256', enc);
    const arr = Array.from(new Uint8Array(digest));
    return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
  } else {
    return btoa(pw);
  }
}

// -------------------------- Auth UI --------------------------
const authArea = document.getElementById('authArea');
const authModalContainer = document.getElementById('authModalContainer');

function renderAuth(){
  authArea.innerHTML = '';
  if(data.currentUser){
    const span = document.createElement('div');
    span.className = 'userBadge';
    span.textContent = data.currentUser;
    const btnLogout = document.createElement('button'); btnLogout.className='btn secondary'; btnLogout.style.marginLeft='8px'; btnLogout.textContent='Logout';
    btnLogout.onclick = ()=>{ data.currentUser = null; saveState(); renderAuth(); renderCreatorNotice(); renderInvoices(); showAuthModalIfNeeded(); };
    authArea.appendChild(span); authArea.appendChild(btnLogout);
  } else {
    const loginBtn = document.createElement('button'); loginBtn.className='btn'; loginBtn.textContent='Login / Register';
    loginBtn.onclick = showAuthModal;
    authArea.appendChild(loginBtn);
  }
}

// create and show auth modal
function showAuthModal(){
  // if already open, do nothing
  if(document.getElementById('authBackdrop')) return;

  const modal = document.createElement('div');
  modal.id = 'authBackdrop';
  modal.className = 'modal-backdrop';
  const box = document.createElement('div');
  box.className = 'modal-box';
  box.innerHTML = `
    <h3>Login or Register</h3>
    <div style="margin-top:8px"><input id="authUser" class="input" placeholder="Username"></div>
    <div style="margin-top:8px"><input id="authPass" class="input" type="password" placeholder="Password"></div>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button id="btnLogin" class="btn secondary">Login</button>
      <button id="btnRegister" class="btn">Register</button>
    </div>
    <div style="margin-top:8px;font-size:13px;color:#666">Passwords are stored hashed (SHA-256) when supported by your browser.</div>
  `;
  modal.appendChild(box);
  modal.addEventListener('click', (e)=>{ if(e.target===modal) { modal.remove(); } });
  authModalContainer.appendChild(modal);
  authModalContainer.style.display = 'block';

  // focus user input
  setTimeout(()=>{ const u = document.getElementById('authUser'); if(u) u.focus(); },50);

  document.getElementById('btnRegister').onclick = async ()=>{
    const u = document.getElementById('authUser').value.trim();
    const p = document.getElementById('authPass').value;
    if(!u||!p){ alert('Enter username and password'); return; }
    if(data.users.find(x=>x.username===u)){ alert('Username exists'); return; }
    const h = await hashPassword(p);
    data.users.push({username:u, passHash:h});
    data.currentUser = u;
    saveState(); renderAuth(); modal.remove(); renderCreatorNotice(); renderInvoices();
  };

  document.getElementById('btnLogin').onclick = async ()=>{
    const u = document.getElementById('authUser').value.trim();
    const p = document.getElementById('authPass').value;
    if(!u||!p){ alert('Enter username and password'); return; }
    const user = data.users.find(x=>x.username===u);
    if(!user){ alert('No such user'); return; }
    const h = await hashPassword(p);
    if(h !== user.passHash){ alert('Bad credentials'); return; }
    data.currentUser = u;
    saveState(); renderAuth(); modal.remove(); renderCreatorNotice(); renderInvoices();
  };
}

function showAuthModalIfNeeded(){
  // show modal on page load if not logged in
  if(!data.currentUser){
    showAuthModal();
  }
}

// -------------------------- Logo handling --------------------------
const appLogoBox = document.getElementById('appLogo');
const logoInput = document.getElementById('logoInput');

function renderLogo(){
  if(data.logoDataUrl){
    appLogoBox.style.background='transparent';
    appLogoBox.innerHTML = `<img src="${data.logoDataUrl}" alt="logo" style="width:100%;height:100%;object-fit:contain;border-radius:8px">`;
  } else {
    appLogoBox.style.background='linear-gradient(135deg,var(--accent),#5aa0ff)';
    appLogoBox.textContent='FA';
  }
}

document.getElementById('applyLogo').addEventListener('click', ()=>{
  const f = logoInput.files[0];
  if(!f){ alert('Choose an image first'); return; }
  const reader = new FileReader();
  reader.onload = ()=>{ data.logoDataUrl = reader.result; saveState(); renderLogo(); alert('Logo uploaded'); };
  reader.readAsDataURL(f);
});
document.getElementById('removeLogo').addEventListener('click', ()=>{ data.logoDataUrl = null; saveState(); renderLogo(); alert('Logo removed'); });

// -------------------------- Invoice editor --------------------------
function addItem(dataItem){
  const tbody = document.querySelector('#itemsTable tbody');
  const tr = document.createElement('tr');
  const name = dataItem?.name||'';
  const qty = dataItem?.qty||1;
  const price = dataItem?.price||0;
  tr.innerHTML = `
    <td><input class="input itemName" value="${name}" placeholder="Description"></td>
    <td><input class="input itemQty" type="number" min="0" value="${qty}"></td>
    <td><input class="input itemPrice" type="number" min="0" step="0.01" value="${price}"></td>
    <td class="itemTotal">${fmt((qty*price))}</td>
    <td><button class="btn secondary btn-sm remove">X</button></td>
  `;
  tbody.appendChild(tr);
  tr.querySelectorAll('input').forEach(i=>i.addEventListener('input', updateTotals));
  tr.querySelector('.remove').addEventListener('click', ()=>{ tr.remove(); updateTotals(); });
  updateTotals();
}

function updateTotals(){
  const rows = document.querySelectorAll('#itemsTable tbody tr');
  let grand = 0;
  rows.forEach(r=>{
    const qty = parseFloat(r.querySelector('.itemQty').value) || 0;
    const price = parseFloat(r.querySelector('.itemPrice').value) || 0;
    const total = qty * price;
    r.querySelector('.itemTotal').textContent = (Number(total)||0).toFixed(2) + ' €';
    grand += total;
  });
  document.getElementById('grandTotal').textContent = (grand||0).toFixed(2) + ' €';
  renderCreatorNotice();
}

document.getElementById('addItem').addEventListener('click', ()=> addItem());
document.getElementById('calcTotals').addEventListener('click', updateTotals);
document.getElementById('loadSample').addEventListener('click', ()=>{
  document.getElementById('invDate').value = new Date().toISOString().slice(0,10);
  document.getElementById('invNumber').value = 'INV-'+Date.now();
  document.querySelector('#itemsTable tbody').innerHTML = '';
  addItem({name:'Service A', qty:2, price:120});
  addItem({name:'Product B', qty:1, price:350});
  updateTotals();
});

// -------------------------- Save / Render invoices --------------------------
function saveInvoice(){
  if(!data.currentUser){ alert('Please login first'); showAuthModal(); return; }
  const rows = document.querySelectorAll('#itemsTable tbody tr');
  if(rows.length===0){ alert('Add at least one item'); return; }
  const items = [];
  rows.forEach(r=>{
    items.push({
      name: r.querySelector('.itemName').value || '',
      qty: parseFloat(r.querySelector('.itemQty').value) || 0,
      price: parseFloat(r.querySelector('.itemPrice').value) || 0,
      total: parseFloat((r.querySelector('.itemTotal').textContent||'0').replace('€','').trim()) || 0
    });
  });
  const inv = {
    id: uid(),
    invNumber: document.getElementById('invNumber').value.trim() || ('INV-'+Date.now()),
    invDate: document.getElementById('invDate').value || new Date().toISOString().slice(0,10),
    items,
    creator: data.currentUser,
    logoDataUrl: data.logoDataUrl || null
  };
  data.invoices.unshift(inv);
  saveState();
  alert('Invoice saved.');
  renderInvoices();
  clearEditor();
}

function clearEditor(){ document.getElementById('invNumber').value=''; document.getElementById('invDate').value=''; document.querySelector('#itemsTable tbody').innerHTML=''; addItem(); updateTotals(); }

document.getElementById('saveInv').addEventListener('click', saveInvoice);

// Render invoices list
function renderInvoices(){
  const cont = document.getElementById('invoicesList'); cont.innerHTML = '';
  if(!data.invoices || data.invoices.length===0){ cont.innerHTML = '<div class="small">No saved invoices</div>'; return; }
  data.invoices.forEach(inv=>{
    const div = document.createElement('div'); div.className='invoice-card';
    let total = inv.items.reduce((s,i)=>s + (i.total|| (i.qty*i.price) ),0);
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-weight:700">${inv.invNumber} • <span class="small">${inv.invDate}</span></div>
        <div class="small">Created by: <strong>${inv.creator}</strong></div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700">${(total||0).toFixed(2)} €</div>
        <div style="margin-top:8px">
          <button class="btn secondary view">View</button>
          <button class="btn pdf">PDF</button>
          <button class="btn secondary del">Delete</button>
        </div>
      </div>
    </div>`;
    div.querySelector('.view').onclick = ()=> loadInvoiceForView(inv);
    div.querySelector('.pdf').onclick = ()=> exportInvoicePDF(inv);
    div.querySelector('.del').onclick = ()=>{
      if(confirm('Delete this invoice?')){ data.invoices = data.invoices.filter(x=>x.id!==inv.id); saveState(); renderInvoices(); }
    };
    cont.appendChild(div);
  });
}

// load an invoice into editor for editing/viewing
function loadInvoiceForView(inv){
  document.getElementById('invNumber').value = inv.invNumber;
  document.getElementById('invDate').value = inv.invDate;
  document.querySelector('#itemsTable tbody').innerHTML = '';
  inv.items.forEach(it=> addItem({name:it.name, qty:it.qty, price:it.price}));
  updateTotals();
}

// show current creator on the editor
function renderCreatorNotice(){
  const el = document.getElementById('creatorNotice');
  if(data.currentUser) el.textContent = 'Logged in as: ' + data.currentUser;
  else el.textContent = 'Not logged in';
}

// -------------------------- PDF Export (includes logo and creator) --------------------------
async function exportInvoicePDF(inv){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt',format:'a4'});
  // draw logo if exists (use inv.logoDataUrl or global)
  const logo = inv.logoDataUrl || data.logoDataUrl;
  if(logo){
    try{ doc.addImage(logo, 'PNG', 40, 30, 80, 40); }catch(e){ try{ doc.addImage(logo, 'JPEG', 40, 30, 80, 40); }catch(e){} }
  }
  doc.setFontSize(18); doc.text('Invoice', 140, 60);
  doc.setFontSize(11); doc.text(`Number: ${inv.invNumber}`, 40, 100);
  doc.text(`Date: ${inv.invDate}`, 40, 116);
  doc.text(`Created by: ${inv.creator}`, 40, 132);

  const body = inv.items.map(it=>[it.name, String(it.qty), (it.price||0).toFixed(2)+' €', ((it.qty||0)*(it.price||0)).toFixed(2)+' €']);
  doc.autoTable({
    startY: 160,
    head: [['Item','Qty','Unit (€)','Total (€)']],
    body,
    styles:{font:'helvetica'},
    headStyles:{fillColor:[240,246,255]},
    margin:{left:40,right:40}
  });

  const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 12 : 400;
  const subtotal = inv.items.reduce((s,i)=>s + ((i.qty||0)*(i.price||0)),0);
  const tax = subtotal * 0.18;
  const total = subtotal + tax;
  doc.setFontSize(12);
  doc.text(`Subtotal: ${subtotal.toFixed(2)} €`, 40, finalY + 20);
  doc.text(`Tax (18%): ${tax.toFixed(2)} €`, 40, finalY + 36);
  doc.text(`Grand total: ${total.toFixed(2)} €`, 40, finalY + 54);

  doc.save(`${inv.invNumber || inv.id}.pdf`);
}

// -------------------------- Download all as ZIP --------------------------
async function downloadAllAsZip(){
  if(!data.invoices || data.invoices.length===0){ alert('No invoices'); return; }
  const zip = new JSZip();
  const { jsPDF } = window.jspdf;
  for(let i=0;i<data.invoices.length;i++){
    const inv = data.invoices[i];
    const doc = new jsPDF({unit:'pt',format:'a4'});
    if(inv.logoDataUrl || data.logoDataUrl){
      const logo = inv.logoDataUrl || data.logoDataUrl;
      try{ doc.addImage(logo, 'PNG', 40, 30, 80, 40); }catch(e){ try{ doc.addImage(logo,'JPEG',40,30,80,40);}catch(e){} }
    }
    doc.setFontSize(18); doc.text('Invoice', 140, 60);
    doc.setFontSize(11); doc.text(`Number: ${inv.invNumber}`, 40, 100);
    doc.text(`Date: ${inv.invDate}`, 40, 116);
    doc.text(`Created by: ${inv.creator}`, 40, 132);
    const body = inv.items.map(it=>[it.name, String(it.qty),(it.price||0).toFixed(2)+' €', ((it.qty||0)*(it.price||0)).toFixed(2)+' €']);
    doc.autoTable({ startY:160, head:[['Item','Qty','Unit (€)','Total (€)']], body, margin:{left:40,right:40} });
    const blob = doc.output('blob');
    zip.file(`${inv.invNumber || inv.id}.pdf`, blob);
  }
  const content = await zip.generateAsync({type:'blob'});
  saveAs(content, 'invoices_all.zip');
}

// -------------------------- Init --------------------------
document.getElementById('applyLogo').addEventListener('click', ()=>{/* handled above */});
document.getElementById('removeLogo').addEventListener('click', ()=>{/* handled above */});
document.getElementById('downloadAll')?.addEventListener('click', downloadAllAsZip);

document.getElementById('clearAll').addEventListener('click', ()=>{
  if(confirm('Delete all saved invoices and users?')){ data = {users:[], invoices:[], logoDataUrl:null, currentUser:null}; saveState(); renderAuth(); renderInvoices(); renderLogo(); renderCreatorNotice(); showAuthModalIfNeeded(); }
});

document.getElementById('addItem').click(); // initial row
renderAuth();
renderLogo();
renderInvoices();
renderCreatorNotice();

// Show auth modal automatically when NOT logged in
setTimeout(()=>{ showAuthModalIfNeeded(); }, 120);

// expose saveInvoice to button (already bound)
document.getElementById('saveInv').addEventListener('click', saveInvoice);

</script>
</body>
</html>
